<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QuickDoc</title>
    <!--css样式-->
    <!--jq-->
    <script src="lib/jquery/jquery-3.2.0.min.js"></script>
    <!--bootstrap-->
    <link rel="stylesheet" href="lib/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <script src="lib/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <!--angular-->
    <script src="lib/angularjs/angular-1.6.3.min.js"></script>
    <script src="lib/angularjs/angular-route.min.js"></script>
    <style>
        body{
            margin: 0;
            padding: 0;
            font-family: "lucida grande", "lucida sans unicode", lucida, helvetica, "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
        }
        .header{
            width: auto;
            height: 50px;
            line-height: 50px;
            background-color: #cccccc;
            font-size: 20px;
        }
        .footer{
            width: auto;
            color: #666666;
            font-size: 12px;
            line-height: 24px;
            background-color: #cccccc;
            padding-top: 20px;
            padding-bottom: 20px;
            text-align: center;
        }
        .left{
            float: left;
            margin-left: 20px;
        }
        .left > a{
            color: inherit;
            text-decoration: none;
        }
        .left > a:hover{
            color: inherit;
            text-decoration: none;
        }
        .right{
            float: right;
            margin-right: 20px;
        }
    </style>
</head>
<body>
<div ng-app="index" ng-controller="indexCtrl">
    <div class="header">
        <div class="left"><a href="#/">5.s-O</a></div>
        <div class="right"><span class="glyphicon glyphicon-user"></span></div>
    </div>
    <ng-view></ng-view>
    <div class="footer">
        五点共圆小组<br>
        陈跃 李宇豪 郑黎明 王杰 吕品田<br>
        ©2017 5.s-O All Rights Reserved
    </div>
</div>
</body>
</html>

<script>
    angular.module('index', ['ngRoute'])
        .config(function ($routeProvider, $locationProvider) {
            $locationProvider.hashPrefix('');
            $routeProvider
                .when('/', {
                    templateUrl: 'datasetList.html'
                })
                .when('/dataList/:datasetId', {
                    templateUrl: 'dataList.html'
                })
                .otherwise({
                    redirectTo:'/'
                });
        })
        .controller('indexCtrl', function ($scope, $location) {
            if(getCookie("qd_username") == null){
                alert("未登录");
                window.location.href="login.html";
            }
        })
        .controller('datasetList', function ($scope, $http) {
            $http.get('php/getDataset.php').then(function (res) {
                $scope.data = res.data.data;
            });
            $scope.add_name = "";
            $scope.add_desc = "";
            $scope.showAdd = function () {
                $(".black").fadeIn(300);
                $(".add").fadeIn(300);
            };
            $scope.hideAdd = function () {
                $(".black").fadeOut(300);
                $(".add").fadeOut(300);
            };
            $scope.add = function () {
                if($scope.add_name == "")
                    alert("名称必须填写");
                else{
                    $http.get('php/addDataset.php', {
                        params: {
                            'name': $scope.add_name,
                            'desc': $scope.add_desc
                        }
                    }).then(function (res) {
                        $scope.hideAdd();
                        $scope.add_name = "";
                        $scope.add_desc = "";
                        location.reload();
                    });
                }
            };
            $scope.delete = function (datasetId) {
                $http.get('php/deleteDataset.php', {
                    params: {
                        'id': datasetId
                    }
                }).then(function (res) {
                    location.reload();
                });
            }
        })
        .controller('dataList', function ($scope, $routeParams, $http) {
            $scope.datasetId = $routeParams.datasetId;
            $http.get('php/getData.php', {
                params: {
                    'datasetId': $scope.datasetId
                }
            }).then(function (res) {
                $scope.data = angular.copy(res.data.data);
                //test
                $scope.data = [
                    {
                        dataId: "90865738162",
                        datasetId: "61459206376",
                        type: "kv",
                        data: {
                            k1: "v1",
                            k2: "v2"
                        }
                    },
                    {
                        dataId: "51099381321",
                        datasetId: "61459206376",
                        type: "kv",
                        data: {
                            k3: "v3",
                            k4: "v4"
                        }
                    }
                ];//
                $scope.opedata = [];
                for(var i=0; i<$scope.data.length; i++){
                    var onedata = $scope.data[i];
                    if(onedata.type=='kv'){
                        var keyList = [];
                        var valueList = [];
                        for(var key in onedata.data){
                            keyList.push(key);
                            valueList.push(onedata.data[key]);
                        }
                        var newdata = {
                            "type": "kv",
                            "keyList": keyList,
                            "valueList": valueList
                        };
                    }
                    $scope.opedata.push(newdata);
                }
            });

            $scope.model = 0;
            $scope.setModel = function (model) {
                $scope.model = model;
            };
            $scope.addKey = function (index) {
                $scope.opedata[index].keyList.push("");
                $scope.opedata[index].valueList.push("");
            };
            $scope.deleteKey = function (index1, index2) {
                $scope.opedata[index1].keyList.splice(index2, 1);
                $scope.opedata[index1].valueList.splice(index2, 1);
            };
            $scope.addData = function () {
                if(document.getElementById("newDataType").value == 'kv'){
                    var temp = {
                        "type": "kv",
                        "keyList": [],
                        "valueList": []
                    };
                    $scope.opedata.push(temp);
                }
            };
            $scope.deleteData = function (index) {
                $scope.opedata.splice(index, 1);
            };
            $scope.range = function(n) {
                return new Array(n);
            };
            $scope.pushData = function () {
                $scope.pushdata = [];
                for(var i=0; i<$scope.opedata.length; i++){
                    var onedata = {};

                    for(var j=0; j<$scope.opedata[i].keyList.length; j++){
                        onedata[$scope.opedata[i].keyList[j]] = $scope.opedata[i].valueList[j];
                    }
                    $scope.pushdata.push(onedata);
                }
                var temp = {};
                temp['datasetId'] = $scope.datasetId;
                temp['data'] = $scope.pushdata;
                $.post('php/pushData.php', {
                    jsonData: JSON.stringify(temp)
                }, function (res) {
                    alert("保存成功");
                    location.reload();
                });
            };
        });

    function uuid(len, radix) {
        var chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
        var uuid = [], i;
        radix = radix || chars.length;

        if (len) {
            // Compact form
            for (i = 0; i < len; i++) uuid[i] = chars[0 | Math.random()*radix];
        } else {
            // rfc4122, version 4 form
            var r;

            // rfc4122 requires these characters
            uuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';
            uuid[14] = '4';

            // Fill in random data.  At i==19 set the high bits of clock sequence as
            // per rfc4122, sec. 4.1.5
            for (i = 0; i < 36; i++) {
                if (!uuid[i]) {
                    r = 0 | Math.random()*16;
                    uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];
                }
            }
        }

        return uuid.join('');
    }

    function getCookie(name) {
        var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
        if(arr=document.cookie.match(reg))
            return unescape(arr[2]);
        else
            return null;
    }

    function delCookie(name) {
        var exp = new Date();
        exp.setTime(exp.getTime() - 1);
        var cval=getCookie(name);
        if(cval!=null)
            document.cookie= name + "="+cval+";expires="+exp.toGMTString();
    }

    function setCookie(name,value,time) {
        var exp = new Date();
        exp.setTime(exp.getTime() + time*1);
        document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString();
    }
</script>